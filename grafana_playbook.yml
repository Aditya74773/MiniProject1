# ---
# - name: Install and Configure Grafana
#   hosts: all
#   become: yes
#   gather_facts: yes

#   vars:
#     grafana_admin_password: "admin123"
#     grafana_port: 3000

#   tasks:
#     - name: Update apt cache
#       apt:
#         update_cache: yes
#         cache_valid_time: 3600

#     - name: Install required packages
#       apt:
#         name:
#           - apt-transport-https
#           - software-properties-common
#           - wget
#           - curl
#         state: present

#     - name: Add Grafana GPG key
#       shell: |
#         wget -q -O - https://apt.grafana.com/gpg.key | gpg --dearmor | sudo tee /etc/apt/keyrings/grafana.gpg > /dev/null
#       register: gpg_key_result
#       changed_when: gpg_key_result.rc == 0

#     - name: Add Grafana repository
#       apt_repository:
#         repo: "deb [signed-by=/etc/apt/keyrings/grafana.gpg] https://apt.grafana.com stable main"
#         state: present
#         filename: grafana

#     - name: Update apt cache after adding repository
#       apt:
#         update_cache: yes

#     - name: Install Grafana
#       apt:
#         name: grafana
#         state: present

#     - name: Configure Grafana admin password
#       lineinfile:
#         path: /etc/grafana/grafana.ini
#         regexp: '^;admin_password ='
#         line: 'admin_password = {{ grafana_admin_password }}'
#         backrefs: yes
#       notify: restart grafana

#     - name: Configure Grafana port
#       lineinfile:
#         path: /etc/grafana/grafana.ini
#         regexp: '^;http_port ='
#         line: 'http_port = {{ grafana_port }}'
#         backrefs: yes
#       notify: restart grafana

#     - name: Ensure Grafana service is started and enabled
#       systemd:
#         name: grafana-server
#         state: started
#         enabled: yes
#         daemon_reload: yes

#     - name: Wait for Grafana to be ready
#       uri:
#         url: "http://localhost:{{ grafana_port }}"
#         method: GET
#         status_code: 200
#       register: grafana_status
#       until: grafana_status.status == 200
#       retries: 10
#       delay: 5

#     - name: Display Grafana installation status
#       debug:
#         msg: "Grafana successfully installed and running on port {{ grafana_port }}"

#   handlers:
#     - name: restart grafana
#       systemd:
#         name: grafana-server
#         state: restarted
# playbooks/grafana.yml
- name: Install and Configure Grafana
  hosts: all
  become: yes
  tasks:
    - name: Install dependencies for repository setup
      ansible.builtin.apt:
        name: ['apt-transport-https', 'software-properties-common', 'wget']
        state: present
        update_cache: yes

    - name: Add Grafana GPG key
      ansible.builtin.shell:
        cmd: wget -q -O - https://packages.grafana.com/gpg.key | apt-key add -

    - name: Add Grafana repository
      ansible.builtin.apt_repository:
        repo: 'deb https://packages.grafana.com/oss/deb stable main'
        state: present
        filename: grafana

    - name: Install Grafana package
      ansible.builtin.apt:
        name: grafana
        state: latest
        update_cache: yes

    - name: Start Grafana service
      ansible.builtin.service:
        name: grafana-server
        state: started
        enabled: yes
    - name: wait for grafana to come online
      ansible.builtin.wait_for:
        port: 3000
        delay: 5
        timeout: 30